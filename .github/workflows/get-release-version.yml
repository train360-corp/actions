##Example Usage
#name: Example Job
#
#on:
#  workflow_dispatch:
#    inputs:
#      type:
#        type: choice
#        description: "Version bump type"
#        options: [PATCH, MINOR, MAJOR]
#        default: PATCH
#        required: true
#
#permissions:
#  contents: write  # needed to push tags & create releases
#
#jobs:
#
#  version:
#    uses: train360-corp/actions/.github/workflows/get-release-version.yml@main
#    with:
#      bump-type: ${{ github.event.inputs.type }}

name: "Get Version From Tags"

on:
  workflow_call:
    inputs:
      bump-type:
        required: false
        default: ""
        type: string
        description: "Optional: MAJOR, MINOR, or PATCH bump"
    outputs:
      previous:
        description: "Latest existing SemVer tag"
        value: ${{ jobs.version.outputs.previous }}
      next:
        description: "Next version tag (if bump-type provided)"
        value: ${{ jobs.version.outputs.next }}

jobs:
  version:
    name: Determine Version
    runs-on: ubuntu-24.04
    outputs:
      previous: ${{ steps.get.outputs.previous }}
      next: ${{ steps.get.outputs.next }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # MUST fetch full history for tags

      - name: Fetch all tags
        run: git fetch --tags

      - name: Determine last and next version
        id: get
        shell: bash
        env:
          BUMP_TYPE: ${{ inputs.bump-type }}
        run: |
          set -euo pipefail

          # Find last SemVer tag (vX.Y.Z)
          latest="$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' | sort -V | tail -n1 || true)"
          if [[ -z "$latest" ]]; then
            latest="v0.0.0"
          fi

          echo "Latest tag: $latest"
          echo "previous=$latest" >> "$GITHUB_OUTPUT"

          # If no bump was requested, stop here
          if [[ -z "$BUMP_TYPE" ]]; then
            echo "No bump requested."
            echo "next=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Strip v and split
          ver="${latest#v}"
          IFS='.' read -r major minor patch <<<"$ver"

          case "$BUMP_TYPE" in
            MAJOR)
              major=$((major+1)); minor=0; patch=0;;
            MINOR)
              minor=$((minor+1)); patch=0;;
            PATCH)
              patch=$((patch+1));;
            *)
              echo "Unknown bump type: $BUMP_TYPE"; exit 1;;
          esac

          new_tag="v${major}.${minor}.${patch}"
          echo "Next tag: $new_tag"
          echo "next=$new_tag" >> "$GITHUB_OUTPUT"
